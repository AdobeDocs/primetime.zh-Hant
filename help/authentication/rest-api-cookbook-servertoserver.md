---
title: REST API逐步指南（伺服器對伺服器）
description: 將API逐步指南伺服器重新安裝至伺服器。
source-git-commit: 326f97d058646795cab5d062fa5b980235f7da37
workflow-type: tm+mt
source-wordcount: '1825'
ht-degree: 0%

---


# REST API逐步指南（伺服器對伺服器） {#rest-api-cookbook-server-to-server}

>[!NOTE]
>
>此頁面的內容僅供參考。 若要使用此API，必須具備目前的Adobe授權。 不允許未經授權使用。


## 概述 {#overview}

本逐步指南檔案旨在詳細說明使用伺服器對伺服器架構實作Adobe Primetime驗證的最佳實務。  它提供基本需求、逐步流程實施，以及生產環境和操作的一般考量。

 

## 元件 {#components}

在有效的伺服器對伺服器解決方案中，涉及下列元件：

 
|類型 |元件 |說明 | | — | — | — | |串流裝置 |串流應用程式 |駐留在用戶流設備上並播放已驗證視頻的程式設計師應用程式。 | | | \[可選\] AuthN模組 |如果串流裝置有使用者代理（即Web瀏覽器），則AuthN模組負責在MVPD IdP上驗證使用者。 | | \[可選\] AuthN設備 | AuthN應用程式 |如果流設備沒有用戶代理（即Web瀏覽器），則AuthN應用程式是程式設計師Web應用程式，使用Web瀏覽器從單獨的用戶設備訪問。 | |程式設計師基礎架構 |程式設計人員服務 |將串流裝置與Adobe Pass服務連結以取得驗證和授權決策的服務。 | |Adobe基礎結構 | Adobe Pass服務 |與MVPD IdP和AuthZ服務整合，並提供驗證和授權決策的服務。 | | MVPD基礎設施 | MVPD IdP |提供憑證式驗證服務以驗證其使用者身分的MVPD端點。 | | | MVPD AuthZ服務 |根據使用者的訂閱、家長控制等提供授權決策的MVPD端點。 |


流量中使用的其他術語定義於
[字彙表](/help/authentication/glossary.md).

## 流量 {#flows}

### 動態用戶端註冊(DCR)


Adobe Pass使用DCR來保護程式設計師應用程式或伺服器與Adobe Pass服務之間的客戶端通信。 DCR流程是獨立、相依和先決條件流程，可在 [動態客戶端註冊](/help/authentication/dynamic-client-registration.md).


### 驗證(authN)

驗證流程用於允許用戶將自己標識到其MVPD以確定用戶是否具有有效帳戶。 

1. 使用者會啟動串流裝置應用程式，並嘗試登入或檢視受保護的內容。
2. 流設備應用程式向程式設計師服務發出請求，以確定設備是否已經驗證。
3. 程式設計人員服務使用DCR註冊應用。
4. 程式設計人員服務會呼叫Adobe Pass服務以檢查串流裝置authN狀態 **checkauthn** API。
5. 對於 **checkauthn** 呼叫會傳回使用者裝置已驗證的狀態，然後應用程式可以繼續進行授權流程。
6. 對於 **checkauthn** 呼叫會傳回「使用者裝置」未驗證的狀態，然後應用程式應等待使用者請求登入。
7. 當用戶請求直接登錄（例如選擇登錄按鈕）或間接登錄（例如當未經驗證時選擇受保護內容）時，流設備應用程式向程式設計師服務發出請求以啟動用戶驗證。 程式設計人員服務通過調用Adobe Pass服務來請求並接收唯一的註冊代碼(regcode) **regcode** API。
8. 程式設計人員服務也會呼叫Adobe Pass服務，以擷取目前MVPD和屬性的清單 **設定** API。 注意：您也可以在流程中稍早呼叫此API並進行快取。
9. 程式設計師服務將重新編碼返回到流式設備應用程式，並在步驟\#7中請求處理的MVPD清單。 注意：已處理的MVPD清單格式由程式設計師指定，可以篩選，以顯式允許或阻止特定MVPD（即允許或阻止清單）。
10. 如果與AuthN裝置不同(即「第二螢幕」)，視需要（即「串流裝置」不支援使用者代理），則「串流裝置」應顯示regcode和URI，供使用者存取AuthN應用程式。 用戶在AuthN設備上的用戶代理中鍵入URI以啟動AuthN應用程式，然後在該應用程式中鍵入註冊代碼。 如果串流裝置與AuthN裝置相同，則可以以程式設計方式將重新編碼傳送至AuthN模組。
11. AuthN模組會顯示MVPD選擇器，以起始使用者驗證。 使用者選取MVPD後，AuthN模組會呼叫 **驗證** 重新導向至MVPD IdP的重新導向程式碼。 當使用者成功與MVPD驗證時，使用者代理會透過Adobe Pass服務重新導向，而成功驗證會以regcode記錄，然後重新導向回AuthN模組。
12. 如果串流裝置與AuthN裝置不同，則AuthN裝置應向使用者顯示成功的驗證訊息，並執行繼續的步驟(例如「成功\! 您現在可以返回遊戲機繼續\[...\]」)。 如果流設備與AuthN設備相同，則流設備可以用寫程式方式檢測身份驗證完成。

 

下圖說明驗證流程：

![](assets/authn-flow.png)

### 授權(authZ)

授權流程用於確定用戶是否有權訪問請求的內容。

1. 每當用戶嘗試在流設備應用上查看受保護的內容時，流設備應用就會調用程式設計師服務來識別內容，並請求啟動流所需的權限和資訊。
1. 程式設計師服務稱為Adobe Pass **授權** 傳遞資源ID的API及其他必要參數。 Adobe服務會使用資源ID呼叫MVPD AuthZ服務，並接收及授權決定，然後傳回給程式設計人員服務。 Adobe Pass服務會快取此授權決策一段可設定的期間。 在後續 **授權** 從程式設計師服務到Adobe Pass服務的調用，只要快取值有效，就將返回該快取值。
1. 如果授權被授予，程式設計師服務應調用Adobe Pass **/tokens/media** API，將傳回已簽署的媒體代號。 程式設計師服務應使用媒體令牌驗證程式庫(JAR)驗證媒體令牌。 如果有效，程式設計師服務應返回在步驟\#1中請求的啟動流（如流URL）所需的權限和權限。
1. 如果拒絕授權，則 **授權** 調用將向程式設計師服務返回錯誤代碼和說明。 程式設計師服務應在步驟\#1中將錯誤代碼和說明（或程式設計師修改的消息）返回到請求。

下圖說明授權流程：

![](assets/authz-flow.png)

### 登出

註銷流程允許用戶刪除當前與應用程式相關聯的標識。

1. 當用戶請求註銷時（即從設備中刪除與應用程式相關聯的當前MVPD帳戶），流設備應用程式調用程式設計師服務，指示它註銷設備。
1. 程式設計人員服務應將Adobe Pass **註銷** API。

下圖說明註銷流程：

![](assets/logout-flow.png)

### \[選用\]預先授權（亦即飛行前）

可使用預先授權來從一組資源中快速判斷使用者可能擁有哪些資源。  此呼叫的結果通常用於自訂個別使用者的UI。

1. 一旦用戶被驗證，Stiming設備可以呼叫程式設計服務來請求用戶有權流的內容。

1. 程式設計人員服務應將Adobe Pass **預先授權** 包含資源ID清單的API，這是簡單字串，通常代表使用者有權串流的管道。 *注意：目前，* ***預先授權*** *呼叫已設定為將清單限制為五(5)個資源ID。 當需要5個以上資源時，需要多個* ***預先授權*** *可進行呼叫，或可將呼叫設定為接受來自MVPD的協定超過五個資源。 實施者應牢記* ***預先授權*** *對MVPD資源和對程式設計師的響應時間都進行調用，並審慎地構造其對調用的使用。*

1. 此 **預先授權** 調用將以JSON對象響應程式設計師服務，該JSON對象包含請求中每個資源ID的TRUE或FALSE值，該請求指示用戶是否有權訪問關聯的通道。 *注意：如果MVPD未針對指定資源ID提供答案（例如，由於網路錯誤或逾時），則值會預設為FALSE。*

1. 程式設計師服務應使用 **預先授權** 呼叫響應以建立程式設計師定義的對流設備的自定義響應，通常根據用戶的權限將演示個性化。

下圖說明預授權流程：

![](assets/preauthz-flow.png)


### \[可選\]元資料

中繼資料可用來擷取MVPD共用的使用者資訊。
 例如，使用者ID、郵遞區號等。

1. 一旦用戶通過驗證，程式設計師服務就可以調用Adobe Pass **usermetadata** 請求已驗證使用者相關資訊的API。

1. 回應會包含指定使用者可用的所有中繼資料。 為每個程式設計師/MVPD整合分別配置特定欄位。

下圖說明預授權流程：

 

![](assets/user-metadata-api-preauthz.png)

 

## 環境和功能需求{#environments}

 

程式設計師應至少建立兩個環境：一個用於生產環境，一個或多個用於測試環境。


### 生產

生產環境應可高度可用，且可適當調整規模，以應付大量或意外的尖峰（例如即時運動、突發新聞）。

 

Adobe Pass服務在遍布美國各地的多個資料中心上運行。  為了從Adobe Pass服務中獲得最佳響應時間（即最低延遲），程式設計師還應建立一個類似於地理位置分散的服務基礎結構。 


程式設計人員服務應將DNS快取限制為最多30秒，以備Adobe需要重新路由流量時使用。 如果資料中心不可用，則可能會發生此情況。\
 

程式設計師應提供生產環境的公共IP範圍。 這些IP將會輸入Adobe Pass基礎架構中允許的IP清單中，以供存取，並由Adobe的公平API使用原則管理。

### 測試

預備環境可能是最小的，但應包含所有系統元件和業務邏輯。 其運作方式應與生產環境類似，且允許在生產環境之外測試發行版本。 理想情況下，測試環境可以連接到Adobe Pass測試環境，供程式設計師使用，並在需要時通過Adobe，這樣我們就可以幫助測試和故障排除。

### 功能需求

程式設計人員服務必須向執行流的設備傳遞準確的設備標識資訊。 此外，程式設計人員服務必須連同連接源埠（在設備資訊欄位中）一起傳遞其執行流的設備的IP:

    **X-Forwarded-For :\&lt;client _ip=&quot;&quot;>** 
    
    其中\&lt;client _ip=&quot;&quot;> 是客戶端公用IP地址
    
     
    
    需要在**regcode**和**授權**呼叫上新增標題
    
    範例：
    
    POST/reggie/v1/{req\_id}/regcode HTTP/1.1
    
    X-Forwarded-For:203.45.101.20
    
     
    
    GET/api/v1/授權HTTP/1.1
    
    X-Forwarded-For:203.45.101.20

 

程式設計人員服務應發送個別MVPD或整合應用程式(如設備IP、源埠、設備資訊、MRSS、可選資料（如ECID）所需的資料和格式。 <!--Please see the documentation for [Passing Device and Connection Information Cookbook](http://tve.helpdocsonline.com/passing-device-information-cookbook)-->.


快取時，程式設計人員服務必須尊重authN和authZ TTL，並在收到通知時使authN或authZ工作階段無效。

程式設計師必須維護與Adobe共用的證書。

<!--
## Related Information {#related}

* [REST API Reference](/help/authentication/rest-api-reference.md)
* [Glossary of Terms](/help/authentication/adobe-pass-glossary.md)
-->